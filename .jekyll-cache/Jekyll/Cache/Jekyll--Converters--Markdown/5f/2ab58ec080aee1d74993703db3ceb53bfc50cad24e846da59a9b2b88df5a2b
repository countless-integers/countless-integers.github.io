I"á9<h1 id="installing-archlinux-on-a-virtualbox-machine">Installing ArchLinux on a VirtualBox Machine</h1>

<h2 id="preparation">Preparation</h2>
<p>You will need about 20-30 minutes of your precious time to follow through will all of this. That assumes everything will go smoothly (why wouldn‚Äôt it?).</p>

<p>First things first ‚Äì obtain the Arch Linux installation media in form of an ISO volume from https://www.archlinux.org/download/.</p>

<p>Assuming you have VirtualBox already installed, create a new VM. ArchLinux is one of the recognized machine types in the VM creator form, so use it. Allocate some of your host machine resources to the machine, adjust accordingly to your rig‚Äôs capabilities.</p>

<p>One thing I‚Äôm going to do, that might not be strictly necessary is to enable EFI under ‚ÄúSystem‚Äù settings (this is related to bootloader configuration described later in this article):</p>

<figure class="image">
  <img src="/img/enable-eif-in-vbox.png" alt="Enable EFI in VirtualBox settings panel" />
  <figcaption>Enable EFI in VirtualBox settings panel</figcaption>
</figure>

<p>One last this to remember ‚Äì if you enable input capturing inside VirtualBox window, remember you host key. On Windows it‚Äôll be the right ‚ÄúCtrl‚Äù key, on MacOs the right ‚ÄúCmd‚Äù. Another useful thing: ‚ÄúCtrl+Home‚Äù will open Vbox machine pop-up allowing you to do things like reboot and ejecting virtual devices (e.g. ArchLinux installation ISO image).</p>

<p>Now it‚Äôs time to follow <a href="https://wiki.archlinux.org/index.php/Installation_guide">ArchLinux installation guide</a> to the letter.</p>

<h2 id="partitioning">Partitioning</h2>
<p>I‚Äôve went with a dynamically allocated 8gb storage volume for my virtual hard drive. I‚Äôve also decided to go with GPT/EFI partitions.</p>

<p>According to most of the guides I could find, the suggested layout would look as follows:</p>

<ol>
  <li><code class="highlighter-rouge">/boot</code> partition, 512 MiB in size at the begging</li>
  <li>swap partition, min. 512 MiB in size</li>
  <li><code class="highlighter-rouge">/</code> partition using the remainder of the drive</li>
</ol>

<p>To make this happen we can use a multitude of tools: <code class="highlighter-rouge">gdisk</code>, <code class="highlighter-rouge">fdisk</code>, <code class="highlighter-rouge">cfdisk</code>. Here is an example using <code class="highlighter-rouge">gdisk</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># gdisk /dev/sda
</code></pre></div></div>

<figure class="image">
  <img src="/img/gdisk-partition-scan.png" alt="Partition set-up in gdisk" />
  <figcaption>Partition set-up in gdisk</figcaption>
</figure>

<p>Running that will start a partition scan to assess the current state of drive‚Äôs partitioning.</p>

<figure class="image">
  <img src="/img/gpt-partitioning.png" alt="Partition set-up in gdisk" />
  <figcaption>Partition set-up in gdisk</figcaption>
</figure>

<p>If you went through some trial and error when creating partitions, <code class="highlighter-rouge">gdisk</code> will kindly suggest to reboot (something <code class="highlighter-rouge">cfdisk</code> failed to do for me). Do so if necessary. In the end you should end up with:</p>

<figure class="image">
  <img src="/img/ls-of-devs.png" alt="List of storage devices" />
  <figcaption>List of storage devices</figcaption>
</figure>

<h2 id="formatting">Formatting</h2>
<p>Assuming the layout created above:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkfs.fat -F32 /dev/sda1
mkswap /dev/sda2
mkfs.ext4 /dev/sda3
</code></pre></div></div>
<h2 id="mount-the-partitions">Mount the partitions</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mount /dev/sda3 /mnt
# mkdir /mnt/boot
# mount /dev/sda1 /mnt/boot
# swapon /dev/sda2 # this should not be necessary because of genfstab
</code></pre></div></div>

<h2 id="boostrap-root-partition">Boostrap root partition</h2>
<p>Time to install the basics:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacstrap /mnt base
</code></pre></div></div>

<p>This will install the basic set of packages required to log in to the system.</p>

<p>To inform the newly bootstrap system of all the partitions we‚Äôre going to use and have them mounted on boot:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</code></pre></div></div>

<p>This will generate a <code class="highlighter-rouge">fstab</code> file, referencing drives by their UUID (as an alternative to referencing them by their labels).</p>

<h2 id="logging-in">Logging-in</h2>
<p>Now we can finally log in to the system with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># arch-chroot /mnt
</code></pre></div></div>

<p>Well, technically changing root is not the same as logging in, more like, well changing root directory to a specified folder‚Ä¶</p>

<h2 id="basic-configuration">Basic configuration</h2>

<p>Time and localization options:</p>

<p>Uncomment <code class="highlighter-rouge">en_US.UTF-8 UTF-8</code> and others needed in <code class="highlighter-rouge">/etc/locale.gen</code> and run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># locale-gen
</code></pre></div></div>

<p>Then:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo "LANG=en_US.UTF-8" &gt; /etc/locale.conf
</code></pre></div></div>

<p>Time:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ln -sf /usr/share/zoneinfo/Europe/&lt;City&gt; /etc/localtime
</code></pre></div></div>

<p>Set hostname:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo vbox &gt; /etc/hostname
</code></pre></div></div>

<p>I‚Äôve used vbox, but you can use whatever. But whatever you use, remember it for this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo -e "\n127.0.1.1\tvbox.localdomain\tvbox" &gt;&gt; /etc/hosts
</code></pre></div></div>

<p><code class="highlighter-rouge">-e</code> flag will make <code class="highlighter-rouge">echo</code> interpret escape character like <code class="highlighter-rouge">\t</code> and help to keep <code class="highlighter-rouge">/etc/hostnames</code> file consistently formatted.</p>

<p>Networking:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl enable dhcpcd
</code></pre></div></div>

<p>for a wired connection. It‚Äôs possible to set-up wireless, but I‚Äôll not cover this, because for a VBox install it does not seem practical.</p>

<p>XOrg and ALSA for audio-video capabilities:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S xf86-video-intel xf86-video-fbdev xorg-server xorg-xinit xorg-twm xterm alsa-utils pulseaudio pulseaudio-alsa
</code></pre></div></div>

<p>VirtualBox guest additions:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S virtualbox-guest-utils virtualbox-guest-modules-arch
</code></pre></div></div>

<p>This will allows us to change screen resolution and a couple of other useful things. <a href="https://wiki.archlinux.org/index.php/VirtualBox#Installation_steps_for_Arch_Linux_guests">More about guest additions and what can they do.</a></p>

<p>A window manager (I chose XFCE4 as a compromise between nice to use and light on resources):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S xfce4 xfce4-goodies # the latter is optional
</code></pre></div></div>

<p>Various stuff you might need:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S vim zsh rsync firefox sudo python python-pip nodejs git openssh
</code></pre></div></div>

<p>Set up password for the root user (interactive command):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># passwd
</code></pre></div></div>

<p>Add a non-root user:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># useradd -m -g users -G adm,lp,wheel,power,audio,video -s /bin/zsh me
# passwd me
# EDITOR=vim visudo  # uncomment %wheel
</code></pre></div></div>

<p>where ‚Äúme‚Äù is you (or whatever login you want to use). <code class="highlighter-rouge">wheel</code> is a sudoers group, why it‚Äôs called like that, I do not know.</p>

<p>That should be enough to get started. So now:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exit
umount /mnt -R # -R because of /boot partition mounted in /mnt/boot
reboot
</code></pre></div></div>

<h2 id="installing-the-bootloader">Installing the bootloader</h2>
<p>Arch guide lists this step near the end, but I decided to make it the first one, since this has been the most troublesome and confusing. Back in the day you would just install to MBR and things would be dandy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S grub
# grub-install /dev/sda
</code></pre></div></div>

<p>However this new madness of (U)EFI firmware came about and now it‚Äôs more like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S grub efibootmgr
# grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub
</code></pre></div></div>

<p>Which should output something like this at the end:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Installation finished. No errors reported.
</code></pre></div></div>

<p>Then we can generate GRUB‚Äôs config file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div></div>

<p>If that goes well, we‚Äôre set.</p>

<h2 id="first-actual-log-in">First actual log-in</h2>
<p>I‚Äôd recommend to login as the non-root users we created to test if that works correctly. If yes I‚Äôd also suggest to run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sudo pacman -Syu
</code></pre></div></div>

<p>Set-up time synchronisation service:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># timedatectl set-ntp true
</code></pre></div></div>

<p>to test that <code class="highlighter-rouge">sudo</code> was configured properly and update the system at the same time.</p>

<p>Pacman is the official package manager and it is great. However there is tons of non-official packages for you to explore. One of the ways to get to them is to install <code class="highlighter-rouge">yaourt</code>. There are others, but I have been using that one for a while and so far it gave me little issues. If you want it start with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S base-devel
</code></pre></div></div>

<p>to install extra base packages necessary to make and install pacman packages from scratch (among other things). Then follow the <a href="https://archlinux.fr/yaourt-en">instructions</a> on the <code class="highlighter-rouge">yaourt</code> homepage (as a non-root user):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># git clone https://aur.archlinux.org/package-query.git
# cd package-query
# makepkg -si
# cd ..
# git clone https://aur.archlinux.org/yaourt.git
# cd yaourt
# makepkg -si
</code></pre></div></div>

<p>This will install <code class="highlighter-rouge">yaourt</code> and its dependency <code class="highlighter-rouge">package-query</code>.</p>

<p>Afterwards, we can try the window manager:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># startxfce4
</code></pre></div></div>

<p>If that fails (I keep forgetting why‚Ä¶), you might need to install a <a href="https://wiki.archlinux.org/index.php/Display_manager">display manager</a>. E.g. to install <a href="https://wiki.archlinux.org/index.php/LightDM">LightDM</a>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S lightdm lightdm-gtk-greeter
</code></pre></div></div>

<p>and then:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sudo lightdm 
</code></pre></div></div>

<p>you can also make it start on-boot using systemd service:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl enable lightdm.service
</code></pre></div></div>

<h2 id="prosper">Prosper</h2>
<p>All is now set, ready to use and further customizations. Enjoy!</p>

<figure class="image">
  <img src="/img/xfce-4.png" alt="End result -- XFCE 4 running at ArchLinux guest VirtualBox installation" />
  <figcaption>End result -- XFCE 4 running at ArchLinux guest VirtualBox installation</figcaption>
</figure>

<h2 id="extra-references">Extra references</h2>

<ul>
  <li><a href="https://unix.stackexchange.com/questions/288865/file-system-boot-is-not-a-fat-efi-system-partition-esp-file-system?answertab=active#tab-top">StackXxchange :: Preparing /boot partition for EFI</a></li>
  <li><a href="https://raw.githubusercontent.com/midfingr/youtube_notes/master/arch_way">Github :: A bit outdated, but still useful installation cheatsheet</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/Installation_guide">Arch Wiki :: Installation Guide</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/GRUB/EFI_examples">Arch Wiki :: EFI examples for GRUB configuration</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/GRUB#Check_if_you_have_GPT_and_an_ESPo">Arch Wiki :: Checking if GPT can be used</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/VirtualBox#Installation_steps_for_Arch_Linux_guests">Arch Wiki :: Installation steps for Arch Linux as VirtualBox guest machine</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/Xorg#Installation">Arch Wiki :: XOrg installation</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/partitioning#GUID_Partition_Table">Arch Wiki :: GUID and partition tables</a></li>
  <li><a href="https://wiki.archlinux.org/index.php/Systemd-timesyncd">Arch Wiki :: Timesync Systemd service</a></li>
  <li><a href="http://averagelinuxuser.com/xfce-look-modern-and-beautiful/">AverageLinuxUser :: Making XFCE4 prettier</a></li>
</ul>
:ET