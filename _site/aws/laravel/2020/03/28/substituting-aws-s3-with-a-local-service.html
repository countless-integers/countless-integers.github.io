<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Substituting AWS S3 with a local service</title>
  <meta name="description" content="S3 is rather cheap and you might wander why bother, but there are multiple good reasons to use a local substitute during development. Among them:">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://countless-integers.github.io/aws/laravel/2020/03/28/substituting-aws-s3-with-a-local-service.html">
  <link rel="alternate" type="application/rss+xml" title="countless-integers blog" href="http://countless-integers.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">countless-integers blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Substituting AWS S3 with a local service</h1>
    <p class="post-meta">Mar 28, 2020</p>
  </header>

  <article class="post-content">
    <p>S3 is rather cheap and you might wander why bother, but there are multiple good reasons to use a local substitute during development. Among them:</p>

<ul>
  <li>working offline, e.g. on a plane</li>
  <li>marginally lower latency</li>
  <li>no risk of bucket name collisions, especially when you create them like crazy during tests</li>
  <li>no fuss with credentials</li>
  <li>tear it apart all you want</li>
  <li>check those pesky edge cases with connectivity errors</li>
</ul>

<p>For context, I’ll mention upfront that this solution was tested on a PHP project written in Laravel, but should be equally applicable for any other technology.</p>

<h2 id="whats-available">What’s available</h2>

<p>Some solutions we’ve tried out:</p>

<ul>
  <li><a href="https://min.io/">MinIO</a> – a storage service in its own right, but maintaining a (mostly) S3-compatible API. Has its own set of tools and a GUI.</li>
  <li><a href="https://github.com/adobe/S3Mock">S3Mock from Adobe</a> – focused on API compatibility, no frills. Written in Java.</li>
  <li><a href="https://github.com/jubos/fake-s3">Fake S3</a> – similar to S3Mock (it’s even referenced in their GH page). Written in Ruby.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>Out of those, we’ve ended up using MinIO. It was mostly because of convenience as we were already using <a href="https://laravel.com/docs/master/homestead">Homestead</a> Vagrant box for development and it came as an installation option with it. It was also important for me to have some tools to inspect all buckets during manual tests and since none of those solutions worked correctly with AWS Cli tool for me, MinIO came through with its GUI and Cli tool (somewhat confusingly called <code class="highlighter-rouge">mc</code> aka <em>Not Midnight Commander</em>).</p>

<p>Not to say that, e.g. S3Mock, was difficult to set up. My collegue came up with the painless solution of using the <a href="https://www.vagrantup.com/docs/provisioning/docker.html">docker provisioner</a> in Vagrant. A snippet you can use in your <code class="highlighter-rouge">Vagrantfile</code> (in our case it meant modifying Homestead’s Vagrantfile):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ...
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.provision "docker" do |d|
        d.pull_images "adobe/s3mock"
        d.run "adobe/s3mock",
          args: "-p 9090:9090 -p 9191:9191"
    end
    # ...
</code></pre></div></div>

<p>However, to get MinIO in Homestead, all you have to do is enable it in the <code class="highlighter-rouge">Homestead.yaml</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>features:
	- minio: true
</code></pre></div></div>

<p>In versions 5.7+ you can also pre-define buckets and their policies that should be provisioned for you in a separate, <code class="highlighter-rouge">buckets</code> section. Beware that you can add that configurations in previous versions without triggering any errors, but it will just be ignored.</p>

<p>Credentials will also need to be updated. MinIO that bundles with Homestead uses a dummy login and password, but unlike the S3Mock (at least by default), it actually checks them, so update your configuration accordingly.</p>

<p>Last thing to do is to do is to update local configuration to use thus provisioned service. Depending on whether you use Flysystem, Laravel’s Filesystem or AWS SDK directly, this step might look differently for you. The important part is that with a local service you’ll need to use something called “path style endpoint” for AWS API. Laravel’s documentation gives an <a href="https://laravel.com/docs/5.7/homestead#configuring-minio">example for the Filesystem configuration</a>. The crux of the matter is that because the service is local, buckets url’s will no longer be conveniently generated for you by AWS. The way around that, bar some local DNS configuration, is to use a static domain and put the bucket name in the path of the url.</p>

<p>Apart from that, it’s business as usual. All the logic written for the actual S3 should work with your local substitute.</p>

<h2 id="downsides">Downsides</h2>

<p>Not everything is rosy though. All of the services strive to keep their API S3 compatible, but your mileage will vary depending on how many features of S3 you actually rely on.</p>

<p>Examples I’ve encountered include:</p>

<ul>
  <li>needing to change from <code class="highlighter-rouge">public</code> policy to <code class="highlighter-rouge">download</code> to achieve a result similar to AWS’s own “public objects”. Somewhat frustratingly, I could not find a clear explanation of policy differences in MinIO docs. I still feel like I was missing some key piece of information to set it up better, but it didn’t help that at the time there was no one centralised information source on available polices. Therefore I’d suggest to check if features like hosted websites, complex ACL setups, CORS policies or object life-cycles will be sufficiently supported for your needs.</li>
  <li>some of the aws cli commands just would not work. Most frustratingly <code class="highlighter-rouge">s3 ls</code> with an endpoint url defined would just throw an error. Same story with third party browsers like Dragon Disk (tried that and some others just for due diligence, didn’t like any of them)</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>All the solutions performed well enough to warrant a recommendation (see the caveats above though). Using a local replacement for S3 makes development feel a bit safer and makes testing less stressful. If you’re considering it, just give it a try and see if it’s an (almost) drop-in replacement or not.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <h2 class="footer-heading">countless-integers blog</h2>
          <li><a href="mailto:"></a></li>
          <li><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/countless-integers">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">countless-integers</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">My random thoughts and weird stories inspired by dailly coding.  This blog runs on the awesome Jekyl.
</p>
      </div>
    </div>

  </div>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', "UA-67251979-1", 'auto');
    ga('send', 'pageview');
  </script>
  
</footer>


  </body>

</html>
