<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PUT requests to ZF2 RESTful controller</title>
  <meta name="description" content="I’ve recently came across a problem writing a CRUD panel that made my reconsider what I knew about REST and/or requesthandling by PHP. Use case was for updat...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://countless-integers.github.io//php/zf2/rest/put/2015/09/17/put-requests-to-zf2-restful-controller.html">
  <link rel="alternate" type="application/rss+xml" title="countless-integers blog" href="http://countless-integers.github.io//feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">countless-integers blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">PUT requests to ZF2 RESTful controller</h1>
    <p class="post-meta">Sep 17, 2015</p>
  </header>

  <article class="post-content">
    <p>I’ve recently came across a problem writing a CRUD panel that made my reconsider what I knew about REST and/or request
handling by PHP. Use case was 
for updating an entity that consisted of some flat data and an image. I chose to send form data with PUT method pretty 
much the same way I’d do with creating a new entity with POST form. Turns out that sending that data from an angular app 
isn’t a problem, dealing with it server side is. I’ve compared payloads send with POST and PUT and on their way out they 
look pretty much alike:</p>

<p>This one with PUT:</p>

<pre><code>------WebKitFormBoundaryqxNZUgM5f0nFT1Z1
Content-Disposition: form-data; name="creation"

{"id":1,"title":"ccc","dateFrom":"2015-08-19","dateTo":"2015-08-22","position":1,"status":0}
------WebKitFormBoundaryqxNZUgM5f0nFT1Z1
Content-Disposition: form-data; name="file"; filename="file.jpg"
Content-Type: image/jpeg


------WebKitFormBoundaryqxNZUgM5f0nFT1Z1--
</code></pre>

<p>And this one with POST:</p>

<pre><code>------WebKitFormBoundaryaDVU9RBkEiCCgfUT
Content-Disposition: form-data; name="creation"

{"title":"sdfsafsa","dateFrom":"2015-09-14","dateTo":"2015-09-30","position":1,"status":0}
------WebKitFormBoundaryaDVU9RBkEiCCgfUT
Content-Disposition: form-data; name="file"; filename="file.jpg"
Content-Type: image/jpeg


------WebKitFormBoundaryaDVU9RBkEiCCgfUT--
</code></pre>

<p>One key difference is the presence of a <code>id</code> in the PUT request, because it’s modifying an existing request it makes 
sense that it’s there. Apart from that it looks the same, but it’s handled differently</p>

<ul>
  <li>For one thing there’s no <code>$_PUT</code> like there’s <code>$_POST</code>, so to even read it you have to resort to things like
<code>parse_str(file_get_contents("php://input"), $put)</code>. Maybe <a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> will solve that.</li>
  <li><code>$_FILES</code> is not populated if you send a <code>multipart/form-data</code>, but there’s a reason for that</li>
</ul>

<p>Anyway ZF2 has a neat controller to handle requests like that in a restful fashion called 
<a href="http://framework.zend.com/manual/current/en/modules/zend.mvc.controllers.html#the-abstractrestfulcontroller"><code>AbstractRestfulController</code></a>. It maps incoming requests based on their HTTP method and 
parameters:</p>

<blockquote>
  <p>POST maps to create(). That method expects a $data argument, usually the $_POST superglobal array. The data should be 
used to create a new entity, and the response should typically be an HTTP 201 response with the Location header 
indicating the URI of the newly created entity and the response body providing the representation.</p>

  <p>PUT maps to update(), and requires that an “id” parameter exists in the route matches; that value is passed as an 
argument to the method. It should attempt to update the given entity, and, if successful, return either a 200 or 202 
response status, as well as the representation of the entity.</p>
</blockquote>

<p>It works quite well up to the point when you’d try to send a multipart form with a file. The it’ll only take you to the 
<code>update</code> method as expected, but you can’t really get the data. I mean you could parse the input stream and carve that 
data, but forget about the file.</p>

<p>I’ve spend some time researching why that’s happening. I’ve checked what PHP docs have to offer on the topic<sup id="fnref:3"><a href="#fn:3" class="footnote">1</a></sup> and how
W3 describes PUT<sup id="fnref:4"><a href="#fn:4" class="footnote">2</a></sup>. Both were hinting, but not conclusive. I’d especially counted on PHP docs to decsribe the exact
way how to handle PUT, but it’s just not there – either it’s too obvious to be mentioned or not popular enough. It
turned out that I’ve overinterpreted what a RESTful PUT request could/should do. I’ve thought that I’ll literally be
able to update (upsert really) an entity (photos and all) 
with it. Not the case. Apparently the way put is supposed to work is to replace a content denoted by the request uri with 
the payload it carries. So if it’s an image it’ll change it to some other file, if it’s an entity with 9 properties and 
the payload contains an entity with 3 properties it’ll override the original with the smaller one (hence replace rather 
than update). So I guess (because I can’t find stone-solid reference for this) it won’t work the way I imagined 
it with multipart forms – because that in itself suggests that it’s at least 2 entities we’re updating. They way my 
colleague put it is that you’d need to requests to get that data to 2 separate uri’s.</p>

<p>I could argue with that, because if you’d encode that very same image to a string and make it a property of that entity, 
it’d be one, inseparable thing. So the representation of the image (binary file, base-encoded string) would be 
difference between a single entity and two independent entities. Nitpicking, maybe.</p>

<p>Anyway onto the practical stuff. I’ve found several workaround for handling PUT requests in ZF2. One was about manually 
setting the request data<sup id="fnref:1"><a href="#fn:1" class="footnote">3</a></sup>. It doesn’t help with my multipart form though. Another one was to put a hidden <code>_method</code>, 
set it to <code>put</code> and send the form as POST request<sup id="fnref:2"><a href="#fn:2" class="footnote">4</a></sup>. It’s valid, but why bother? It still needs to send it to 
a uri that has a id in it. That in itself should be enough to tell creation from update apart. So I just send it 
as post and then do this:</p>

<pre><code>public function create($data)
{
    $id = $this-&gt;params('id', null);
    if ($id) {
       return $this-&gt;update($id, $data);
    }
    // ...
}
</code></pre>

<p>Simple and effective. Shame it doesn’t work out of the box, but it’s not a too terribly inconvenient either.</p>

<div class="footnotes">
  <ol>
    <li id="fn:3">
      <p><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">W3 method definitions</a> <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p><a href="http://php.net/manual/pl/features.file-upload.put-method.php">PHP put method support</a> <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:1">
      <p><a href="http://stackoverflow.com/a/26676252/1105871">Stack post</a> <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p><a href="http://blog.piotr.rybaltowski.pl/rest-w-zf2-metody-put-i-delete-w-formularzach/">blog post about handling put/delete in ZF2 (in polish)</a> <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <h2 class="footer-heading">countless-integers blog</h2>
          <li><a href="mailto:"></a></li>
          <li><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/countless-integers">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">countless-integers</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">My random thoughts and weird stories inspired by dailly coding.  This blog runs on the awesome Jekyl.
</p>
      </div>
    </div>

  </div>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', "UA-67251979-1", 'auto');
    ga('send', 'pageview');
  </script>
  
</footer>


  </body>

</html>
